project: GOROSKOPE
artifact: astrologer_workflow_spec
version: "1.0"

globals:
  locale: "ru"
  markdown: "MarkdownV2"
  ui:
    step_prefix: "üîπ –®–∞–≥ {step}/{total}"
    nav:
      back: "‚¨ÖÔ∏è –ù–∞–∑–∞–¥"
      cancel: "‚õî –û—Ç–º–µ–Ω–∞"
      menu: "üè† –ú–µ–Ω—é"
  user_fields:
    - birth_date
    - time_mode            # exact | range | unknown
    - birth_time           # HH:MM (only if exact)
    - time_range           # night|morning|day|evening (only if range)
    - birth_city_query
    - birth_city_selected  # "City, Country"
    - lat
    - lon
    - tz
    - focus                # general|love|money|energy|move
    - output_length        # short|long
    - style                # strict|poetic

main_menu:
  message: "–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª:"
  buttons:
    row1: ["üîÆ –ü—Ä–æ—Å—á–∏—Ç–∞—Ç—å –≥–æ—Ä–æ—Å–∫–æ–ø", "üìÜ –ü—Ä–æ–≥–Ω–æ–∑"]
    row2: ["üíû –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å", "üë§ –ü—Ä–æ—Ñ–∏–ª—å"]
    row3: ["üßæ –ò—Å—Ç–æ—Ä–∏—è", "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏"]

flows:

  natal_wizard:
    id: "natal"
    total_steps: 6

    step1_product:
      step: 1
      state: "NATAL_PRODUCT"
      message: "{step_prefix}\n–ß—Ç–æ —Å—á–∏—Ç–∞–µ–º?"
      buttons:
        row1: ["üß¨ –ù–∞—Ç–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞"]
        row2: ["üè† –ú–µ–Ω—é"]
      transitions:
        "üß¨ –ù–∞—Ç–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞": "step2_birth_date"
        "üè† –ú–µ–Ω—é": "main_menu"

    step2_birth_date:
      step: 2
      state: "NATAL_BIRTH_DATE"
      message: "{step_prefix}\n–í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è:\n\n‚Ä¢ –§–æ—Ä–º–∞—Ç: –î–î.MM.–ì–ì–ì–ì\n‚Ä¢ –ü—Ä–∏–º–µ—Ä: 19.10.1989"
      input:
        type: "text"
        validate: "date_ddmmyyyy"
        on_fail: "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –¥–∞—Ç–∞. –í–≤–µ–¥–∏—Ç–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –î–î.MM.–ì–ì–ì–ì."
      buttons:
        row1: ["‚¨ÖÔ∏è –ù–∞–∑–∞–¥", "‚õî –û—Ç–º–µ–Ω–∞"]
      transitions:
        "valid_input": "step3_time_mode"
        "‚¨ÖÔ∏è –ù–∞–∑–∞–¥": "step1_product"
        "‚õî –û—Ç–º–µ–Ω–∞": "main_menu"

    step3_time_mode:
      step: 3
      state: "NATAL_TIME_MODE"
      message: "{step_prefix}\n–í—Ä–µ–º—è —Ä–æ–∂–¥–µ–Ω–∏—è –∑–Ω–∞–µ—Ç–µ?"
      buttons:
        row1: ["‚úÖ –ó–Ω–∞—é —Ç–æ—á–Ω–æ–µ", "üïí –ü—Ä–∏–º–µ—Ä–Ω–æ", "‚ùì –ù–µ –∑–Ω–∞—é"]
        row2: ["‚¨ÖÔ∏è –ù–∞–∑–∞–¥", "‚õî –û—Ç–º–µ–Ω–∞"]
      transitions:
        "‚úÖ –ó–Ω–∞—é —Ç–æ—á–Ω–æ–µ": "step3a_birth_time_exact"
        "üïí –ü—Ä–∏–º–µ—Ä–Ω–æ": "step3b_birth_time_range"
        "‚ùì –ù–µ –∑–Ω–∞—é": "step4_city"
        "‚¨ÖÔ∏è –ù–∞–∑–∞–¥": "step2_birth_date"
        "‚õî –û—Ç–º–µ–Ω–∞": "main_menu"

    step3a_birth_time_exact:
      step: 3
      state: "NATAL_BIRTH_TIME_EXACT"
      message: "{step_prefix}\n–í–≤–µ–¥–∏—Ç–µ —Ç–æ—á–Ω–æ–µ –≤—Ä–µ–º—è —Ä–æ–∂–¥–µ–Ω–∏—è:\n\n‚Ä¢ –§–æ—Ä–º–∞—Ç: –ß–ß:–ú–ú\n‚Ä¢ –ü—Ä–∏–º–µ—Ä: 12:05"
      input:
        type: "text"
        validate: "time_hhmm"
        on_success_set:
          time_mode: "exact"
          birth_time: "{input}"
          time_range: null
        on_fail: "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –≤—Ä–µ–º—è. –ü—Ä–∏–º–µ—Ä: 09:30"
      buttons:
        row1: ["‚¨ÖÔ∏è –ù–∞–∑–∞–¥", "‚õî –û—Ç–º–µ–Ω–∞"]
      transitions:
        "valid_input": "step4_city"
        "‚¨ÖÔ∏è –ù–∞–∑–∞–¥": "step3_time_mode"
        "‚õî –û—Ç–º–µ–Ω–∞": "main_menu"

    step3b_birth_time_range:
      step: 3
      state: "NATAL_BIRTH_TIME_RANGE"
      message: "{step_prefix}\n–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏–º–µ—Ä–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω:"
      buttons:
        row1: ["üåô –ù–æ—á—å (00‚Äì06)", "üåÖ –£—Ç—Ä–æ (06‚Äì12)"]
        row2: ["‚òÄÔ∏è –î–µ–Ω—å (12‚Äì18)", "üåÜ –í–µ—á–µ—Ä (18‚Äì24)"]
        row3: ["‚¨ÖÔ∏è –ù–∞–∑–∞–¥", "‚õî –û—Ç–º–µ–Ω–∞"]
      on_click_set:
        time_mode: "range"
        birth_time: null
      transitions:
        "üåô –ù–æ—á—å (00‚Äì06)": { next: "step4_city", set: { time_range: "night" } }
        "üåÖ –£—Ç—Ä–æ (06‚Äì12)": { next: "step4_city", set: { time_range: "morning" } }
        "‚òÄÔ∏è –î–µ–Ω—å (12‚Äì18)": { next: "step4_city", set: { time_range: "day" } }
        "üåÜ –í–µ—á–µ—Ä (18‚Äì24)": { next: "step4_city", set: { time_range: "evening" } }
        "‚¨ÖÔ∏è –ù–∞–∑–∞–¥": "step3_time_mode"
        "‚õî –û—Ç–º–µ–Ω–∞": "main_menu"

    step4_city:
      step: 4
      state: "NATAL_CITY_INPUT"
      message: "{step_prefix}\n–í–≤–µ–¥–∏—Ç–µ –≥–æ—Ä–æ–¥ —Ä–æ–∂–¥–µ–Ω–∏—è:\n\n‚Ä¢ –ú–æ–∂–Ω–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º/–∞–Ω–≥–ª–∏–π—Å–∫–æ–º\n‚Ä¢ –ü—Ä–∏–º–µ—Ä: –ó–∞–ø–æ—Ä–æ–∂—å–µ / Zaporizhzhia"
      input:
        type: "text"
        validate: "minlen_2"
        on_success_set:
          birth_city_query: "{input}"
      buttons:
        row1: ["‚¨ÖÔ∏è –ù–∞–∑–∞–¥", "‚õî –û—Ç–º–µ–Ω–∞"]
      transitions:
        "valid_input": "step4a_city_suggest"
        "‚¨ÖÔ∏è –ù–∞–∑–∞–¥": "step3_time_mode"
        "‚õî –û—Ç–º–µ–Ω–∞": "main_menu"

    step4a_city_suggest:
      step: 4
      state: "NATAL_CITY_SUGGEST"
      message: "{step_prefix}\n–£—Ç–æ—á–Ω–∏—Ç–µ –≥–æ—Ä–æ–¥ (–≤—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç):"
      dynamic_buttons:
        source: "city_suggestions"      # returns up to 5
        format: "{name}, {country}"
      static_buttons:
        row_last: ["üîé –ò—Å–∫–∞—Ç—å —Å–Ω–æ–≤–∞", "‚¨ÖÔ∏è –ù–∞–∑–∞–¥", "‚õî –û—Ç–º–µ–Ω–∞"]
      transitions:
        "dynamic_city_choice":
          next: "step5_focus"
          set_from_city:
            birth_city_selected: "{city.name}, {city.country}"
            lat: "{city.lat}"
            lon: "{city.lon}"
            tz: "{city.tz}"
        "üîé –ò—Å–∫–∞—Ç—å —Å–Ω–æ–≤–∞": "step4_city"
        "‚¨ÖÔ∏è –ù–∞–∑–∞–¥": "step4_city"
        "‚õî –û—Ç–º–µ–Ω–∞": "main_menu"

    step5_focus:
      step: 5
      state: "NATAL_FOCUS"
      message: "{step_prefix}\n–ù–∞ —á—Ç–æ —Å–¥–µ–ª–∞—Ç—å –∞–∫—Ü–µ–Ω—Ç –≤ —Ä–∞–∑–±–æ—Ä–µ?"
      buttons:
        row1: ["üßø –û–±—â–∏–π", "üíû –û—Ç–Ω–æ—à–µ–Ω–∏—è"]
        row2: ["üí∞ –î–µ–Ω—å–≥–∏/–ö–∞—Ä—å–µ—Ä–∞", "‚ö° –†–µ—Å—É—Ä—Å/–≠–Ω–µ—Ä–≥–∏—è"]
        row3: ["üß≠ –ü–µ—Ä–µ–µ–∑–¥", "‚¨ÖÔ∏è –ù–∞–∑–∞–¥"]
        row4: ["‚õî –û—Ç–º–µ–Ω–∞"]
      transitions:
        "üßø –û–±—â–∏–π": { next: "step6_confirm", set: { focus: "general" } }
        "üíû –û—Ç–Ω–æ—à–µ–Ω–∏—è": { next: "step6_confirm", set: { focus: "love" } }
        "üí∞ –î–µ–Ω—å–≥–∏/–ö–∞—Ä—å–µ—Ä–∞": { next: "step6_confirm", set: { focus: "money" } }
        "‚ö° –†–µ—Å—É—Ä—Å/–≠–Ω–µ—Ä–≥–∏—è": { next: "step6_confirm", set: { focus: "energy" } }
        "üß≠ –ü–µ—Ä–µ–µ–∑–¥": { next: "step6_confirm", set: { focus: "move" } }
        "‚¨ÖÔ∏è –ù–∞–∑–∞–¥": "step4_city"
        "‚õî –û—Ç–º–µ–Ω–∞": "main_menu"

    step6_confirm:
      step: 6
      state: "NATAL_CONFIRM"
      message_template: |
        {step_prefix}
        –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ:

        ‚Ä¢ –î–∞—Ç–∞: {birth_date}
        ‚Ä¢ –í—Ä–µ–º—è: {time_display}
        ‚Ä¢ –ì–æ—Ä–æ–¥: {birth_city_selected}
        ‚Ä¢ –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å: {tz}
        ‚Ä¢ –§–æ–∫—É—Å: {focus_display}

        –ù–∞–∂–º–∏—Ç–µ ¬´–°—á–∏—Ç–∞—Ç—å¬ª, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Ä–∞–∑–±–æ—Ä.
      computed_fields:
        time_display:
          exact: "‚úÖ {birth_time}"
          range: "üïí {time_range_display}"
          unknown: "‚ùì –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"
        time_range_display_map:
          night: "–ù–æ—á—å (00‚Äì06)"
          morning: "–£—Ç—Ä–æ (06‚Äì12)"
          day: "–î–µ–Ω—å (12‚Äì18)"
          evening: "–í–µ—á–µ—Ä (18‚Äì24)"
        focus_display_map:
          general: "–û–±—â–∏–π"
          love: "–û—Ç–Ω–æ—à–µ–Ω–∏—è"
          money: "–î–µ–Ω—å–≥–∏/–ö–∞—Ä—å–µ—Ä–∞"
          energy: "–†–µ—Å—É—Ä—Å/–≠–Ω–µ—Ä–≥–∏—è"
          move: "–ü–µ—Ä–µ–µ–∑–¥"
      buttons:
        row1: ["‚úÖ –°—á–∏—Ç–∞—Ç—å", "‚úèÔ∏è –î–∞—Ç–∞", "‚úèÔ∏è –í—Ä–µ–º—è"]
        row2: ["‚úèÔ∏è –ì–æ—Ä–æ–¥", "‚úèÔ∏è –§–æ–∫—É—Å"]
        row3: ["‚¨ÖÔ∏è –ù–∞–∑–∞–¥", "‚õî –û—Ç–º–µ–Ω–∞"]
      transitions:
        "‚úÖ –°—á–∏—Ç–∞—Ç—å": "natal_calculate"
        "‚úèÔ∏è –î–∞—Ç–∞": "step2_birth_date"
        "‚úèÔ∏è –í—Ä–µ–º—è": "step3_time_mode"
        "‚úèÔ∏è –ì–æ—Ä–æ–¥": "step4_city"
        "‚úèÔ∏è –§–æ–∫—É—Å": "step5_focus"
        "‚¨ÖÔ∏è –ù–∞–∑–∞–¥": "step5_focus"
        "‚õî –û—Ç–º–µ–Ω–∞": "main_menu"

    natal_calculate:
      state: "NATAL_CALC"
      actions:
        - build_payload_json: true
        - persist_request: { kind: "natal", status: "processing" }
        - astrology_engine_call: { mode: "{time_mode}", focus: "{focus}", length: "{output_length}", style: "{style}" }
        - persist_result: true
        - update_request_status: "done"
      output:
        message_template: "{report}"
        buttons:
          row1: ["‚≠ê –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ø—Ä–æ—Ñ–∏–ª—å", "üîÅ –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å"]
          row2: ["üßæ –í –∏—Å—Ç–æ—Ä–∏—é", "üè† –ú–µ–Ω—é"]
      transitions:
        "‚≠ê –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ø—Ä–æ—Ñ–∏–ª—å": "profile_save"
        "üîÅ –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å": "natal_wizard_prefill"
        "üßæ –í –∏—Å—Ç–æ—Ä–∏—é": "history_last"
        "üè† –ú–µ–Ω—é": "main_menu"

report_blueprint:
  natal:
    sections_order:
      - title
      - passport
      - core_axes
      - portrait
      - focus_block
      - recommendations
      - summary
    templates:

      title:
        strict: "üîÆ –ù–∞—Ç–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞ ‚Äî —Ä–∞–∑–±–æ—Ä"
        poetic: "üîÆ –ù–∞—Ç–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞ ‚Äî —Å–∏–º—Ñ–æ–Ω–∏—è –≤–∞—à–µ–≥–æ –Ω–µ–±–∞"

      passport:
        format: |
          ü™™ –ü–∞—Å–ø–æ—Ä—Ç –∫–∞—Ä—Ç—ã
          ‚Ä¢ –î–∞—Ç–∞: {birth_date}
          ‚Ä¢ –í—Ä–µ–º—è: {time_display}
          ‚Ä¢ –ú–µ—Å—Ç–æ: {birth_city_selected}
          ‚Ä¢ –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å: {tz}

      core_axes:
        include_when:
          exact_or_range: true
        strict: |
          üß≠ –û–ø–æ—Ä–Ω—ã–µ –æ—Å–∏
          ‚Ä¢ –ê—Å—Ü–µ–Ω–¥–µ–Ω—Ç: {asc_or_placeholder}
          ‚Ä¢ –£–ø—Ä–∞–≤–∏—Ç–µ–ª—å –ê—Å—Ü–µ–Ω–¥–µ–Ω—Ç–∞: {asc_ruler_or_placeholder}
          ‚Ä¢ –î–æ–º–∏–Ω–∏—Ä—É—é—â–∞—è —Å—Ç–∏—Ö–∏—è: {element_or_placeholder}
        poetic: |
          üß≠ –û–ø–æ—Ä–Ω—ã–µ –æ—Å–∏
          ‚Ä¢ –í—Ä–∞—Ç–∞ –ø—Ä–æ—è–≤–ª–µ–Ω–∏—è (ASC): {asc_or_placeholder}
          ‚Ä¢ –í–µ–¥—É—â–∞—è –Ω–æ—Ç–∞ (—É–ø—Ä–∞–≤–∏—Ç–µ–ª—å ASC): {asc_ruler_or_placeholder}
          ‚Ä¢ –°—Ç–∏—Ö–∏—è, —á—Ç–æ –¥–µ—Ä–∂–∏—Ç –≤–∞—Å: {element_or_placeholder}

      portrait:
        strict: |
          üß† –ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø–æ—Ä—Ç—Ä–µ—Ç
          1) –í–æ–ª—è –∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: {sun_block}
          2) –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º: {moon_block}
          3) –°–æ—Ü–∏–∞–ª—å–Ω–∞—è –ø–æ–¥–∞—á–∞: {persona_block}
          4) –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã: {strengths_bullets}
          5) –ó–æ–Ω—ã —Ä–æ—Å—Ç–∞: {shadows_bullets}
        poetic: |
          üß† –ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø–æ—Ä—Ç—Ä–µ—Ç
          1) –í–∞—à–µ ¬´—Ö–æ—á—É¬ª: {sun_block}
          2) –í–∞—à–µ ¬´—á—É–≤—Å—Ç–≤—É—é¬ª: {moon_block}
          3) –í–∞—à –æ–±—Ä–∞–∑ –≤ –º–∏—Ä–µ: {persona_block}
          4) –î–∞—Ä—ã: {strengths_bullets}
          5) –£–∑–ª—ã —Ä–æ—Å—Ç–∞: {shadows_bullets}

      focus_block:
        by_focus:
          general: |
            üéØ –ì–ª–∞–≤–Ω–∞—è —Ç–µ–º–∞
            {general_focus_text}
          love: |
            üíû –û—Ç–Ω–æ—à–µ–Ω–∏—è
            {love_focus_text}
          money: |
            üí∞ –î–µ–Ω—å–≥–∏ –∏ –∫–∞—Ä—å–µ—Ä–∞
            {money_focus_text}
          energy: |
            ‚ö° –†–µ—Å—É—Ä—Å –∏ —ç–Ω–µ—Ä–≥–∏—è
            {energy_focus_text}
          move: |
            üß≠ –ü–µ—Ä–µ–µ–∑–¥ –∏ –ø–µ—Ä–µ–º–µ–Ω—ã
            {move_focus_text}

      recommendations:
        format: |
          ‚úÖ –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
          {recommendations_5_10_bullets}

      summary:
        format: |
          ‚ú® –†–µ–∑—é–º–µ
          ‚Ä¢ {summary_1}
          ‚Ä¢ {summary_2}
          ‚Ä¢ {summary_3}

placeholders_rules:
  when_time_unknown:
    hide_sections:
      - core_axes
    wording:
      - "–ë–µ–∑ —Ç–æ—á–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ —è –Ω–µ —Ñ–∏–∫—Å–∏—Ä—É—é –ê—Å—Ü–µ–Ω–¥–µ–Ω—Ç –∏ –¥–æ–º–∞ –∫–∞–∫ —Ñ–∞–∫—Ç."
      - "–ï—Å–ª–∏ –∑–∞—Ö–æ—Ç–∏—Ç–µ ‚Äî –ø–µ—Ä–µ—Å—á–∏—Ç–∞–µ–º —Å –≤—Ä–µ–º–µ–Ω–µ–º –∏–ª–∏ –¥–∏–∞–ø–∞–∑–æ–Ω–æ–º."

post_actions:
  profile_save:
    set: "profiles.upsert_from_current_payload"
    reply: "‚≠ê –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –ø—Ä–æ—Ñ–∏–ª—å."
    next: "main_menu"

  natal_wizard_prefill:
    behavior:
      - load_profile_if_exists: true
      - prefill_fields: true
      - start_at: "step2_birth_date"   # allow quick edit
    next: "natal_wizard.step2_birth_date"

validators:
  date_ddmmyyyy: { regex: "^\\d{2}\\.\\d{2}\\.\\d{4}$", logical: "valid_calendar_date && not_future" }
  time_hhmm: { regex: "^(?:[01]\\d|2[0-3]):[0-5]\\d$" }
  minlen_2: { min_length: 2 }

dynamic_sources:
  city_suggestions:
    input: "{birth_city_query}"
    method: "rapidfuzz_top5"
    dataset: "data/cities_sample.json"
