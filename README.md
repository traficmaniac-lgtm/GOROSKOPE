# Гороскоп Telegram Bot (v0.4 Repair + Self-Test)

Telegram-бот на aiogram 3.x с Tkinter-лаунчером, SQLite и опциональным OpenAI. Цель — «запуск за 2 клика» на Windows 10 и само‑диагностика.

## Запуск за 2 клика
1. Двойной клик по `START_ALL.bat` (Windows, требуется установленный Python Launcher `py -3.12`; Python 3.14 не поддерживается).
2. Скрипт создаст `.venv`, поставит зависимости, скопирует `.env` из `.env.example` (если нет) и откроет `.env` в Notepad. Вставьте `BOT_TOKEN`, сохраните файл — лаунчер откроется автоматически.
3. Лог установки: `logs/setup.log`. Если что-то пошло не так, сообщение появится в консоли и в этом логе.

## Альтернативный запуск
- Ручной лаунчер: `START_LAUNCHER.bat` (тот же лог `logs/setup.log`).
- CLI без GUI: `.venv\Scripts\python.exe launch.py --run-bot` (предварительно заполните `.env`).
- Остановка бота из GUI: вкладка «Запуск» → «Остановить бота».

## Диагностика и самопроверка
- В GUI появилась вкладка **«Диагностика»**: показывает версию Python, путь к интерпретатору, наличие `.venv` и `.env`, путь к БД и каталог `logs`. Кнопки: «Проверить зависимости», «Проверить токен Telegram» (реальный `getMe`), «Проверить OpenAI» (короткий запрос), «Открыть логи».
- CLI команды:
  - `python launch.py --print-env` — выводит настройки с маскировкой токенов.
  - `python launch.py --selftest` — запускает `tools/selftest.py` (проверяет роутеры, callback-кнопки, prompt builder, QuotaService). Ожидаемый вывод: `ALL TESTS PASSED`.
  - `python launch.py --test-ai` — собирает примерный промпт и делает вызов AI (OpenAI или stub).

## Требования к окружению
- Поддерживаемая версия Python: **3.12.x**. Python 3.14 блокируется в стартовых батниках и не поддерживается.
- Необходим `py -3.12` (Windows Python Launcher). На macOS/Linux используйте системный `python3.12` для ручного запуска.

## GUI вкладки
- **Настройки** — редактирование и валидация `.env` (BOT_TOKEN, USE_OPENAI, OPENAI_API_KEY, LOG_LEVEL, DB_PATH) + кнопка «Проверить OpenAI».
- **Диагностика** — быстрые проверки окружения, зависимостей, токена Telegram, OpenAI и кнопка для открытия каталога `logs` в проводнике.
- **Тест AI** — генерация промпта и вызов текущего AI (stub/OpenAI) без Telegram.
- **Симулятор** — чат-эмулятор сценария «Гороскоп» с валидацией данных и списанием квоты в SQLite.
- **Запуск** — запуск/остановка `bot.py` в подпроцессе, просмотр логов.
- **Мини-редактор** — сохранение правок в `bot_overrides.json` (FREE_QUOTA, тексты, стиль промпта).

## Логи и база
- Логи приложения: `logs/app.log` (бот). Логи лаунчера: `logs/launcher.log`. Лог установки и батников: `logs/setup.log`.
- База данных: `DB_PATH` из `.env` (по умолчанию `bot.db`).
- Каталог `logs` создается автоматически при запуске.

## AI режимы
- **OpenAI**: `USE_OPENAI=true` + `OPENAI_API_KEY` → модель `gpt-4o-mini`. Ошибки (401/429/5xx) показываются в GUI и логах.
- **Stub**: если `USE_OPENAI=false` или ключ отсутствует/SDK не установлен, включается StubAIService; пользователь видит пометку о демо-режиме.
